kind: pipeline
type: exec
name: ci

steps:
  - name: build
    commands:
      - flutter build apk --debug --split-per-abi
      - mv build/app/outputs/flutter-apk/*-debug.apk `pwd`
      - rename app pro.kherel.selfprivacy *.apk && rename debug "$DRONE_COMMIT" *.apk
      - ls *.apk
    environment:
     JAVA_HOME: /nix/store/i9bbniszl2g4pkjy1lbcchg0lnk69xn6-openjdk-headless-11.0.15+10/lib/openjdk
     ANDROID_HOME: /nix/store/xvr502awmkzaw29gv0nmg2yr29ksz5wy-androidsdk/libexec/android-sdk
     ANDROID_SDK_ROOT: /nix/store/xvr502awmkzaw29gv0nmg2yr29ksz5wy-androidsdk/libexec/android-sdk

node:
  server: builder

---
kind: pipeline
type: exec
name: release

steps:
  - name: build
    commands:
      - nixos-container stop isolated
      - nixos-container start isolated
      - eval `ssh-agent -s`
      - echo "$SSH_PRIVATE_KEY" | ssh-add -
      - scp -r `pwd` isolated:/var/lib/builder
      - ssh isolated "cd src && flutter build apk --release --split-per-abi"
      - scp isolated:/var/lib/builder/src/build/app/outputs/flutter-apk/*-release.apk `pwd`
    environment:
      SSH_PRIVATE_KEY:
        from_secret: SSH_PRIVATE_KEY

  - name: deploy
    commands:
      - rename app pro.kherel.selfprivacy *.apk && rename release "$DRONE_TAG" *.apk
      - ls *.apk

trigger:
  ref:
    include:
      - refs/tags/v.*

node:
  server: builder
